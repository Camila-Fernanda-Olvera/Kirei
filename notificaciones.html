<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones - Kirei</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="CSS/dashboard-paciente.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .notificacion-item {
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(77,191,201,0.10);
            border: 2px solid #4DBFC9;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .notificacion-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(77,191,201,0.18);
        }
        .notificacion-item.pendiente {
            border-left: 4px solid #FFC107;
            background: linear-gradient(135deg, rgba(255,193,7,0.05) 0%, rgba(255,255,255,0.95) 100%);
        }
        .notificacion-item.leida {
            border-left: 4px solid #28A745;
            opacity: 0.8;
        }
        .notificacion-item.completada {
            border-left: 4px solid #6C757D;
            opacity: 0.6;
        }
        .notificacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .notificacion-titulo {
            font-weight: 700;
            color: #197074;
            font-size: 1.1rem;
        }
        .notificacion-fecha {
            font-size: 0.9rem;
            color: #6C757D;
        }
        .notificacion-mensaje {
            color: #23404A;
            font-size: 1rem;
            line-height: 1.4;
        }
        .notificacion-tipo {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .tipo-medicamento { background: rgba(77,191,201,0.15); color: #197074; }
        .tipo-cita { background: rgba(25,112,116,0.15); color: #197074; }
        .tipo-mensaje_familiar { background: rgba(255,143,177,0.15); color: #C43556; }
        .tipo-recordatorio { background: rgba(255,193,7,0.15); color: #856404; }
        .tipo-emergencia { background: rgba(220,53,69,0.15); color: #721C24; }
        .filtros-container {
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(77,191,201,0.10);
            border: 2px solid #4DBFC9;
        }
        .filtro-btn {
            background: rgba(77,191,201,0.1);
            border: 2px solid #4DBFC9;
            color: #197074;
            border-radius: 25px;
            padding: 0.5rem 1.2rem;
            margin: 0.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .filtro-btn:hover, .filtro-btn.activo {
            background: #4DBFC9;
            color: white;
            transform: translateY(-1px);
        }
        @media (max-width: 600px) {
            .filtros-container { padding: 1rem; }
            .filtro-btn { width: 100%; margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body class="dashboard-paciente-bg">
    <header class="paciente-header position-relative">
        <div class="logo-area">
            <i class="bi bi-bell"></i> Notificaciones Kirei
        </div>
        <div class="d-flex align-items-center gap-3 position-absolute top-0 end-0 pe-4 pt-3" style="z-index: 1051;">
            <a href="dashboard-paciente.html" class="btn btn-outline-primary btn-sm"><i class="bi bi-arrow-left"></i> Volver</a>
        </div>
    </header>
    <main class="container py-4">
        <div class="filtros-container mb-4 text-center">
            <button class="filtro-btn activo" data-filtro="todas" id="btnFiltroTodas"><i class="bi bi-bell"></i> Todas</button>
            <button class="filtro-btn" data-filtro="pendiente" id="btnFiltroPendientes"><i class="bi bi-hourglass-split"></i> Pendientes</button>
            <button class="filtro-btn" data-filtro="medicamento" id="btnFiltroMedicamentos"><i class="bi bi-capsule"></i> Medicamentos</button>
            <button class="filtro-btn" data-filtro="cita" id="btnFiltroCitas"><i class="bi bi-calendar-event"></i> Citas</button>
            <button class="filtro-btn" data-filtro="mensaje_familiar" id="btnFiltroMensajes"><i class="bi bi-chat-dots"></i> Mensajes</button>
            <button class="filtro-btn" data-filtro="recordatorio" id="btnFiltroRecordatorios"><i class="bi bi-bell"></i> Recordatorios</button>
            <button class="filtro-btn" data-filtro="emergencia" id="btnFiltroEmergencias"><i class="bi bi-exclamation-triangle"></i> Emergencias</button>
        </div>
        <div id="listaNotificaciones"></div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="JS/notificaciones.js"></script>
    <script>
    let notificacionesData = [];
    let filtroActual = 'todas';
    document.addEventListener('DOMContentLoaded', function() {
        cargarNotificaciones();
        document.querySelectorAll('.filtro-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('activo'));
                this.classList.add('activo');
                filtroActual = this.dataset.filtro;
                renderizarNotificaciones();
            });
        });
    });
    function cargarNotificaciones() {
        fetch('PHP/notificaciones.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'action=get_notificaciones'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && Array.isArray(data.notificaciones)) {
                notificacionesData = data.notificaciones;
                renderizarNotificaciones();
            } else {
                notificacionesData = [];
                renderizarNotificaciones();
            }
        });
    }
    function renderizarNotificaciones() {
        const cont = document.getElementById('listaNotificaciones');
        cont.innerHTML = '';
        let filtradas = notificacionesData;
        if (filtroActual !== 'todas') {
            if (filtroActual === 'pendiente') filtradas = filtradas.filter(n => n.estado === 'pendiente');
            else filtradas = filtradas.filter(n => n.tipo === filtroActual);
        }
        if (filtradas.length === 0) {
            cont.innerHTML = `<div class='text-center text-muted py-4'><i class='bi bi-bell-slash' style='font-size:2.5rem;'></i><br>Sin notificaciones</div>`;
            return;
        }
        filtradas.forEach(n => {
            cont.innerHTML += `
                <div class="notificacion-item ${n.estado}">
                    <div class="notificacion-header">
                        <span class="notificacion-titulo"><i class="bi ${obtenerIcono(n.tipo)}"></i> ${n.titulo}</span>
                        <span class="notificacion-fecha">${n.fecha_creacion.split(' ')[0]}</span>
                    </div>
                    <div class="notificacion-mensaje">${n.mensaje}</div>
                    <span class="notificacion-tipo tipo-${n.tipo}">${capitalizar(n.tipo)}</span>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" title="Ver" onclick="mostrarToastNotificacion(${n.id})"><i class="bi bi-eye"></i></button>
                        ${n.estado !== 'completada' ? `<button class="btn btn-outline-success btn-sm" title="Marcar como leída" onclick="marcarLeida(${n.id})"><i class="bi bi-check"></i></button>` : ''}
                    </div>
                </div>
            `;
        });
    }
    function obtenerIcono(tipo) {
        const iconos = {
            'medicamento': 'bi-capsule',
            'cita': 'bi-calendar-event',
            'mensaje_familiar': 'bi-chat-dots',
            'recordatorio': 'bi-bell',
            'emergencia': 'bi-exclamation-triangle'
        };
        return iconos[tipo] || 'bi-bell';
    }
    function capitalizar(txt) {
        return txt.charAt(0).toUpperCase() + txt.slice(1);
    }
    function mostrarToastNotificacion(id) {
        const notif = notificacionesData.find(n => n.id === id);
        if (!notif) return;
        if (window.sistemaNotificaciones && typeof window.sistemaNotificaciones.mostrarNotificacion === 'function') {
            window.sistemaNotificaciones.mostrarNotificacion({
                tipo: notif.tipo,
                titulo: notif.titulo,
                mensaje: notif.mensaje,
                prioridad: notif.prioridad
            });
        } else {
            alert(notif.titulo + '\n' + notif.mensaje);
        }
    }
    function marcarLeida(id) {
        fetch('PHP/notificaciones.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=marcar_leida&notificacion_id=${id}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                cargarNotificaciones();
            }
        });
    }
    // Sincronizar modo oscuro al cargar
    (function sincronizarModoOscuro() {
        if (localStorage.getItem('modoOscuro') === 'true') {
            document.body.classList.add('modo-oscuro');
        } else {
            document.body.classList.remove('modo-oscuro');
        }
    })();
    // Si tienes un switch de modo oscuro, sincronízalo aquí también
    const switchDarkMode = document.getElementById('switchDarkMode');
    if (switchDarkMode) {
        if (localStorage.getItem('modoOscuro') === 'true') {
            switchDarkMode.checked = true;
        }
        switchDarkMode.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('modo-oscuro');
                localStorage.setItem('modoOscuro', 'true');
            } else {
                document.body.classList.remove('modo-oscuro');
                localStorage.setItem('modoOscuro', 'false');
            }
        });
    }
    // Aplicar clases de tarjetas oscuras si corresponde
    function aplicarClasesTarjetasOscuras() {
        const tarjetas = document.querySelectorAll('.tarjeta');
        tarjetas.forEach((tarjeta, index) => {
            tarjeta.classList.remove('card-pastel-1', 'card-pastel-2', 'card-pastel-3', 'card-pastel-4', 'card-pastel-5');
            if (document.body.classList.contains('modo-oscuro')) {
                const darkClass = `dark-card-${(index % 4) + 1}`;
                tarjeta.classList.add(darkClass);
            } else {
                const pastelClass = `card-pastel-${(index % 5) + 1}`;
                tarjeta.classList.add(pastelClass);
            }
        });
    }
    // Llamar al cargar y cuando cambie el modo
    aplicarClasesTarjetasOscuras();
    if (switchDarkMode) {
        switchDarkMode.addEventListener('change', aplicarClasesTarjetasOscuras);
    }
    // Si cambias notificaciones dinámicamente, vuelve a llamar aplicarClasesTarjetasOscuras()
    </script>
</body>
</html> 